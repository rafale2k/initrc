#!/bin/bash
# ~/dotfiles/bin/gcm ã®ä¸­ã«è¿½è¨˜ã—ã¦ãƒ†ã‚¹ãƒˆ
echo "Debug: API_KEY is [$GEMINI_API_KEY]"

_ai_generate_commit_proposals() {
    [[ -z "$GEMINI_API_KEY" ]] && return 1
    local raw_diff=$(git diff --cached | head -c 10000)
    [[ -z "$raw_diff" ]] && return 1

    # Pythonã§APIã‚’å©ã
    export DIFF_DATA="$raw_diff"
    export GKEY="$GEMINI_API_KEY"

    python3 <<'PYEOF'
import json, urllib.request, os, sys

def fetch():
    key = os.environ.get("GKEY")
    diff = os.environ.get("DIFF_DATA", "")
    # 2026å¹´ç¾åœ¨ã®æœ€æ–°å®‰å®šç‰ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key={key}"
    
    payload = {
        "contents": [{
            "parts": [{"text": f"Provide 3 distinct git commit messages in English. Conventional Commits format. Output ONLY 3 lines.\n\nDiff:\n{diff}"}]
        }]
    }

    try:
        req = urllib.request.Request(url, data=json.dumps(payload).encode("utf-8"), headers={"Content-Type": "application/json"})
        with urllib.request.urlopen(req, timeout=15) as res:
            data = json.loads(res.read().decode("utf-8"))
            text = data['candidates'][0]['content']['parts'][0]['text']
            lines = [l.strip().lstrip('1234567890.+-* ').strip('` ') for l in text.strip().split('\n') if l.strip()]
            for l in lines[:3]: print(l)
    except Exception as e:
        print(f"DEBUG: Error: {e}", file=sys.stderr)

fetch()
PYEOF
    unset DIFF_DATA GKEY
}

gcm() {
    local diff=$(git diff --cached)
    [[ -z "$diff" ]] && { echo "âŒ No changes staged."; return 1; }

    echo "ğŸ¤– AI is thinking (Gemini 2.5 Flash)..."
    local proposals=$(_ai_generate_commit_proposals)

    local choices=""
    [[ -n "$proposals" ]] && choices="$proposals"$'\n'"---"
    choices="$choices"$'\n'"feat: update configuration"$'\n'"fix: minor bug fixes"$'\n'"[Manual Input]"

    local selected=$(echo "$choices" | grep -v '^$' | fzf \
        --height 60% --reverse --border --ansi \
        --header "Select AI proposal (ESC to cancel)" \
        --preview "git diff --cached --color=always" \
        --preview-window "right:50%:wrap")

    [[ -z "$selected" || "$selected" == "---" ]] && { echo "Aborted."; return 0; }
    if [[ "$selected" == "[Manual Input]" ]]; then
        echo -n "âœï¸ Enter message: " ; read -r msg ; selected=$msg
    fi
    [[ -n "$selected" ]] && git commit -m "$selected"
}

gcm
