#!/bin/bash

# =================================================================
# bin/gcm v2.1 - AI-Driven Commit Assistant (120% Edition)
# Optimized for initrc project structure
# =================================================================

# 0. ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿ (initrc æ§‹æˆã«åˆã‚ã›ã‚‹)
DOTFILES_ROOT="${DOTFILES_ROOT:-$HOME/dotfiles}"
[ -f "$DOTFILES_ROOT/common/.env.local" ] && source "$DOTFILES_ROOT/common/.env.local"

_ai_generate_commit_proposals() {
    # 1. APIã‚­ãƒ¼ã®ãƒã‚§ãƒƒã‚¯
    if [[ -z "$GEMINI_API_KEY" ]]; then
        echo "âŒ GEMINI_API_KEY is not set in $DOTFILES_ROOT/common/.env.local" >&2
        return 1
    fi

    # 2. Diff ã®çµ±è¨ˆæƒ…å ±ã¨ä¸­èº«ã‚’å–å¾— (ãƒˆãƒ¼ã‚¯ãƒ³ç¯€ç´„ã®ãŸã‚ head ã§åˆ¶é™)
    local diff_stat=$(git diff --cached --stat)
    local full_diff=$(git diff --cached | head -c 15000)

    # 3. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    local system_prompt="You are an expert software engineer.
Analyze the provided 'git diff' and output exactly 3 distinct, high-quality commit messages.
Rules:
- Format: Conventional Commits (feat:, fix:, refactor:, chore:, docs:)
- Style: Imperative mood, concise (max 50 chars for summary).
- Output: ONLY the 3 lines of messages, no numbers, no explanations."

    # 4. llm ã‚³ãƒãƒ³ãƒ‰ã§ç”Ÿæˆ (Gemini 2.5 Flash æŒ‡å®š)
    # â€» llm ã‚³ãƒãƒ³ãƒ‰ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æ
    echo -e "Context - File Statistics:
$diff_stat

Actual Diff:
$full_diff" | \
    llm -m gemini-2.5-flash -s "$system_prompt" 2>/dev/null
}

main() {
    # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
    local diff=$(git diff --cached)
    if [[ -z "$diff" ]]; then
        echo "âŒ No changes staged. (Use 'git add' first)"
        return 1
    fi

    # fzf ã‚„ llm ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    if ! command -v fzf &>/dev/null || ! command -v llm &>/dev/null; then
        echo "âŒ Required tools (fzf, llm) not found."
        return 1
    fi

    echo "ğŸ¤– AI is analyzing changes (Gemini via llm)..."
    
    local proposals
    proposals=$(_ai_generate_commit_proposals)

    # é¸æŠè‚¢ã®æ§‹ç¯‰
    local choices
    choices=$(echo -e "${proposals}\n---\n[Manual Input]")

    # fzf ã§é¸æŠ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»˜ã)
    local selected
    selected=$(echo "$choices" | grep -v '^$' | fzf \
        --height 60% --reverse --border --ansi \
        --header "Select AI Proposal (ESC to cancel)" \
        --preview "git diff --cached --color=always" \
        --preview-window "right:50%:wrap")

    # ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
    if [[ -z "$selected" || "$selected" == "---" ]]; then
        echo "Aborted."
        return 0
    fi

    # æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
    if [[ "$selected" == "[Manual Input]" ]]; then
        echo -n "âœï¸ Enter message: "
        read -r selected
    fi

    # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
    if [[ -n "$selected" ]]; then
        git commit -m "$selected"
        
        # ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ (clipcopy é–¢æ•°/ã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚Œã°æ´»ç”¨)
        if command -v clipcopy &>/dev/null; then
            echo -n "$selected" | clipcopy
            echo "ğŸ“‹ Message copied to clipboard."
        fi
        echo "âœ¨ Committed successfully!"
    fi
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦å®Ÿè¡Œ
main "$@"
