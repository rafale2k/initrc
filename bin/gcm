#!/bin/bash

# =================================================================
# gcm v2.0 - AI-Driven Commit Assistant (120% Edition)
# =================================================================

_ai_generate_commit_proposals() {
    # 1. APIã‚­ãƒ¼ã®ãƒã‚§ãƒƒã‚¯
    if [[ -z "$GEMINI_API_KEY" ]]; then
        echo "âŒ GEMINI_API_KEY is not set in ~/.dotfiles_env" >&2
        return 1
    fi

    # 2. Diff ã®çµ±è¨ˆæƒ…å ±ã¨ä¸­èº«ã‚’å–å¾—
    local diff_stat=$(git diff --cached --stat)
    local full_diff=$(git diff --cached | head -c 15000)

    # 3. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (ç†Ÿç·´ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æŒ¯ã‚‹èˆžã„ã‚’æŒ‡å®š)
    local system_prompt="You are an expert software engineer.
Analyze the provided 'git diff' and output exactly 3 distinct, high-quality commit messages.
Rules:
- Format: Conventional Commits (feat:, fix:, refactor:, chore:, docs:)
- Style: Imperative mood, concise (max 50 chars for summary).
- Output: ONLY the 3 lines of messages, no numbers, no explanations."

    # 4. llm ã‚³ãƒžãƒ³ãƒ‰ã§ç”Ÿæˆ
    echo -e "Context - File Statistics:\n$diff_stat\n\nActual Diff:\n$full_diff" | \
    llm -m gemini-2.5-flash -s "$system_prompt" 2>/dev/null
}

gcm() {
    local diff=$(git diff --cached)
    [[ -z "$diff" ]] && { echo "âŒ No changes staged. (Use 'ga' first)"; return 1; }

    echo "ðŸ¤– AI is analyzing changes (Gemini via llm)..."
    
    local proposals
    proposals=$(_ai_generate_commit_proposals)

    # fzf ç”¨ã®é¸æŠžè‚¢ä½œæˆ
    local choices=""
    choices+="$proposals"
    choices+=$'\n---\n[Manual Input]'

    # fzf ã§é¸æŠž (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»˜ã)
    local selected
    selected=$(echo "$choices" | grep -v '^$' | fzf \
        --height 60% --reverse --border --ansi \
        --header "Select AI Proposal (ESC to cancel)" \
        --preview "git diff --cached --color=always" \
        --preview-window "right:50%:wrap")

    [[ -z "$selected" || "$selected" == "---" ]] && { echo "Aborted."; return 0; }

    # æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
    if [[ "$selected" == "[Manual Input]" ]]; then
        echo -n "âœï¸ Enter message: " ; read -r msg ; selected=$msg
    fi

    if [[ -n "$selected" ]]; then
        git commit -m "$selected"
        
        # v1.10.0 ã§å°Žå…¥ã—ãŸ clipcopy ã‚’æ´»ç”¨
        if command -v clipcopy &>/dev/null; then
            echo -n "$selected" | clipcopy
            echo "ðŸ“‹ Message copied to clipboard."
        fi
    fi
}

gcm
