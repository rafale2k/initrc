#!/bin/bash

# =================================================================
# gcm v2.0 - AI-Driven Commit Assistant (120% Edition)
# =================================================================

_ai_generate_commit_proposals() {
    [[ -z "$GEMINI_API_KEY" ]] && { echo "âŒ GEMINI_API_KEY not set"; return 1; }

    # 1. Diff ã®çµ±è¨ˆæƒ…å ±ã‚’å–å¾— (ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç†è§£ç”¨)
    local diff_stat=$(git diff --cached --stat)
    # 2. Diff ã®ä¸­èº«ã‚’å–å¾— (æœ€å¤§ 15000 æ–‡å­—ç¨‹åº¦ã«åˆ¶é™)
    local full_diff=$(git diff --cached | head -c 15000)

    # 3. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å®šç¾©
    local system_prompt="You are an expert software engineer.
Analyze the provided 'git diff' and output exactly 3 distinct, high-quality commit messages.
Rules:
- Format: Conventional Commits (e.g., feat:, fix:, refactor:, chore:, docs:)
- Style: Imperative mood, concise (max 50 chars for summary).
- Output: ONLY the 3 lines of messages, no numbers, no explanations."

    # 4. llm ã‚³ãƒžãƒ³ãƒ‰ã§ç”Ÿæˆ (llm-gemini ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨)
    # çµ±è¨ˆæƒ…å ±ã¨è©³ç´° Diff ã‚’çµ„ã¿åˆã‚ã›ã¦æŠ•ã’ã‚‹
    echo -e "Context - File Statistics:\n$diff_stat\n\nActual Diff:\n$full_diff" | \
    llm -m gemini-2.0-flash-exp -s "$system_prompt" 2>/dev/null
}

gcm() {
    local diff=$(git diff --cached)
    [[ -z "$diff" ]] && { echo "âŒ No changes staged."; return 1; }

    echo "ðŸ¤– AI is analyzing your changes (Gemini 2.0 Flash via llm)..."
    
    # AI æ¡ˆã‚’å–å¾—
    local proposals
    proposals=$(_ai_generate_commit_proposals)

    # fzf ç”¨ã®é¸æŠžè‚¢ã‚’ä½œæˆ
    local choices=""
    choices+="$proposals"
    choices+=$'\n---\n[Manual Input]'

    # fzf ã§é¸æŠž
    local selected
    selected=$(echo "$choices" | grep -v '^$' | fzf \
        --height 60% --reverse --border --ansi \
        --header "Select AI Proposal for Commit (ESC to cancel)" \
        --preview "git diff --cached --color=always" \
        --preview-window "right:50%:wrap")

    [[ -z "$selected" || "$selected" == "---" ]] && { echo "Aborted."; return 0; }

    # æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
    if [[ "$selected" == "[Manual Input]" ]]; then
        echo -n "âœï¸ Enter message: " ; read -r msg ; selected=$msg
    fi

    if [[ -n "$selected" ]]; then
        # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
        git commit -m "$selected"
        
        # ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚‚ã‚³ãƒ”ãƒ¼ (v1.10.0 ã§å°Žå…¥ã—ãŸ clipcopy ã‚’æ´»ç”¨)
        if command -v clipcopy &>/dev/null; then
            echo -n "$selected" | clipcopy
            echo "ðŸ“‹ Message copied to clipboard."
        fi
    fi
}

gcm
