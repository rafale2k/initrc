#!/bin/bash

# =================================================================
# ðŸš€ bin/aic v3.1 - AI-Driven Commit Assistant (Next-Gen Edition)
# Optimized for Conventional Commits & Gemini 2.5 Flash
# =================================================================

# 0. ç’°å¢ƒå¤‰æ•°ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
DOTPATH="${DOTPATH:-$(cd "$(dirname "$0")/.." && pwd)}"
[ -f "$DOTPATH/common/.env.local" ] && source "$DOTPATH/common/.env.local"

_ai_generate_commit_proposals() {
    if [[ -z "$GEMINI_API_KEY" ]]; then
        if ! llm keys list | grep -q "gemini" 2>/dev/null; then
            echo "âš ï¸  GEMINI_API_KEY is not detected in env or llm keys." >&2
            echo "    Please set it via 'export GEMINI_API_KEY=...' or 'llm keys set gemini'" >&2
            return 1
        fi
    fi

    # 1. Diff ã®çµ±è¨ˆæƒ…å ±ã¨ä¸­èº«ã‚’å–å¾— (Gemini 2.5 ã®åºƒå¤§ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ´»ã‹ã—ã¤ã¤ 20000 æ–‡å­—ç¨‹åº¦ã«æ‹¡å¼µ)
    local diff_stat=$(git diff --cached --stat)
    local full_diff=$(git diff --cached | head -c 20000)

    # 2. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (Gemini 2.5 Flash å‘ã‘ã®é«˜åº¦ãªæŒ‡ç¤º)
    local system_prompt="You are a world-class software engineer. 
Analyze the provided git diff and generate EXACTLY 3 high-quality commit message proposals in English.

Requirements:
1. Follow Conventional Commits (e.g., feat:, fix:, refactor:, chore:, docs:, ci:).
2. Use the imperative mood (e.g., 'Add' instead of 'Added').
3. Subject line must be under 50 characters.
4. If the change is complex, focus on the primary 'Why' and 'What'.
5. Output EXACTLY 3 lines. One proposal per line.
6. NO markdown, NO numbers, NO bullet points, NO extra text. 

Example Output:
feat(auth): add OAuth2 provider support
fix(api): resolve memory leak in connection pool
chore(deps): update dependency-xyz to v2.0.0"

    # 3. llm ã‚³ãƒžãƒ³ãƒ‰ã§ç”Ÿæˆ (Gemini 2.5 Flash ã‚’æ˜Žç¤º)
    echo -e "Context - File Statistics:\n$diff_stat\n\nActual Diff:\n$full_diff" | \
    llm prompt -m gemini-2.5-flash -s "$system_prompt" 2>/dev/null
}

main() {
    # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç¢ºèª
    if git diff --cached --quiet; then
        echo "âŒ No changes staged. (Use 'git add' first)"
        return 1
    fi

    # ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
    if ! command -v fzf &>/dev/null || ! command -v llm &>/dev/null; then
        echo "âŒ Required tools (fzf, llm) not found."
        return 1
    fi

    echo "ðŸ¤– AI is analyzing changes (Gemini 2.5 Flash)..."
    
    local proposals
    proposals=$(_ai_generate_commit_proposals)

    if [[ -z "$proposals" ]]; then
        echo "âŒ AI failed to generate proposals."
        return 1
    fi

    # é¸æŠžè‚¢ã®æ§‹ç¯‰
    local choices
    choices=$(echo -e "${proposals}\n---\n[Manual Input]")

    # fzf ã§é¸æŠž (å³å´ã« diff ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º)
    local selected
    selected=$(echo "$choices" | grep -v '^$' | fzf \
        --height 60% --reverse --border --ansi \
        --header "Select Gemini 2.5 Proposal (ESC to cancel)" \
        --preview "git diff --cached --color=always" \
        --preview-window "right:60%:wrap")

    # ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
    if [[ -z "$selected" || "$selected" == "---" ]]; then
        echo "Aborted."
        return 0
    fi

    # æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
    if [[ "$selected" == "[Manual Input]" ]]; then
        echo -n "âœï¸  Enter message: "
        read -r selected
    fi

    # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
    if [[ -n "$selected" ]]; then
        git commit -m "$selected"
        
        # ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
        if command -v pbcopy &>/dev/null; then
            echo -n "$selected" | pbcopy
            echo "ðŸ“‹ Message copied to clipboard."
        elif command -v xclip &>/dev/null; then
            echo -n "$selected" | xclip -selection clipboard
            echo "ðŸ“‹ Message copied to clipboard."
        fi
        echo "âœ¨ Committed successfully with Gemini 2.5!"
    fi
}

main "$@"
