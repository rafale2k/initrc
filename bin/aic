#!/bin/bash

# =================================================================
# bin/aic v2.2 - AI-Driven Commit Assistant (Refactored)
# Optimized for initrc project structure & Gemini 2.5 Flash
# =================================================================

# 0. ç’°å¢ƒå¤‰æ•°ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
# install.sh ã§å®šç¾©ã•ã‚Œã‚‹ç’°å¢ƒå¤‰æ•°ã‚„ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
DOTPATH="${DOTPATH:-$(cd "$(dirname "$0")/.." && pwd)}"
[ -f "$DOTPATH/common/.env.local" ] && source "$DOTPATH/common/.env.local"

_ai_generate_commit_proposals() {
    # 1. APIã‚­ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ (llmã‚³ãƒžãƒ³ãƒ‰å´ã§è¨­å®šæ¸ˆã¿ãªã‚‰ã‚¹ãƒ«ãƒ¼ã§ã‚‚OK)
    # if [[ -z "$GEMINI_API_KEY" ]]; then
    #     echo "âŒ GEMINI_API_KEY is not set." >&2
    #     return 1
    # fi

    # 2. Diff ã®çµ±è¨ˆæƒ…å ±ã¨ä¸­èº«ã‚’å–å¾— (15000æ–‡å­—ã§ã‚«ãƒƒãƒˆã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ç¯€ç´„)
    local diff_stat=$(git diff --cached --stat)
    local full_diff=$(git diff --cached | head -c 15000)

    # 3. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    local system_prompt="You are an expert software engineer.
Analyze the provided 'git diff' and output exactly 3 distinct, high-quality commit messages.
Rules:
- Format: Conventional Commits (feat:, fix:, refactor:, chore:, docs:, style:, test:)
- Language: Japanese (æ—¥æœ¬èªž)
- Style: Imperative mood, concise.
- Output: ONLY the 3 lines of messages, no numbers, no explanations."

    # 4. llm ã‚³ãƒžãƒ³ãƒ‰ã§ç”Ÿæˆ
    echo -e "Context - File Statistics:\n$diff_stat\n\nActual Diff:\n$full_diff" | \
    llm prompt -m gemini-2.5-flash -s "$system_prompt" 2>/dev/null
}

main() {
    # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç¢ºèª
    if ! git diff --cached --quiet; then
        : # å¤‰æ›´ã‚ã‚Š
    else
        echo "âŒ No changes staged. (Use 'git add' first)"
        return 1
    fi

    # ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
    if ! command -v fzf &>/dev/null || ! command -v llm &>/dev/null; then
        echo "âŒ Required tools (fzf, llm) not found."
        return 1
    fi

    echo "ðŸ¤– AI is analyzing changes (Gemini 2.5 Flash)..."
    
    local proposals
    proposals=$(_ai_generate_commit_proposals)

    if [[ -z "$proposals" ]]; then
        echo "âŒ AI failed to generate proposals."
        return 1
    fi

    # é¸æŠžè‚¢ã®æ§‹ç¯‰
    local choices
    choices=$(echo -e "${proposals}\n---\n[Manual Input]")

    # fzf ã§é¸æŠž (å³å´ã« diff ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º)
    local selected
    selected=$(echo "$choices" | grep -v '^$' | fzf \
        --height 60% --reverse --border --ansi \
        --header "Select AI Proposal for 'aic' (ESC to cancel)" \
        --preview "git diff --cached --color=always" \
        --preview-window "right:60%:wrap")

    # ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
    if [[ -z "$selected" || "$selected" == "---" ]]; then
        echo "Aborted."
        return 0
    fi

    # æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰
    if [[ "$selected" == "[Manual Input]" ]]; then
        echo -n "âœï¸ Enter message: "
        read -r selected
    fi

    # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
    if [[ -n "$selected" ]]; then
        git commit -m "$selected"
        
        # ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ (OSåˆ¤å®š)
        if command -v pbcopy &>/dev/null; then # macOS
            echo -n "$selected" | pbcopy
            echo "ðŸ“‹ Message copied to clipboard."
        elif command -v xclip &>/dev/null; then # Linux
            echo -n "$selected" | xclip -selection clipboard
            echo "ðŸ“‹ Message copied to clipboard."
        fi
        echo "âœ¨ Committed successfully!"
    fi
}

main "$@"
