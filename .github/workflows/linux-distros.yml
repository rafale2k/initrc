name: ğŸ³ Linux Distros Compatibility Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  matrix-test:
    name: ğŸš€ ${{ matrix.os }} Build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: "Ubuntu 24.04"
            image: "ubuntu:24.04"
            pkg_manager: "apt"
          - os: "AlmaLinux 9"
            image: "almalinux:9"
            pkg_manager: "dnf"

    container:
      image: ${{ matrix.image }}
      options: --user root

    steps:
      # --- 1. ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« & ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å›é¿ ---
      - name: ğŸ“¦ Pre-install Git & Fix Ownership
        run: |
          if [ "${{ matrix.pkg_manager }}" = "apt" ]; then
            export DEBIAN_FRONTEND=noninteractive
            apt-get update && apt-get install -y git
          else
            # AlmaLinuxã®curlè¡çªå›é¿ã®ãŸã‚ --allowerasing ã‚’ä»˜ä¸
            dnf install -y --allowerasing git
          fi
          # Git ã® 'dubious ownership' ã‚¨ãƒ©ãƒ¼ã‚’å›é¿
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # --- 2. ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ ---
      - name: ğŸšš Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # --- 3. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ„ãƒ¼ãƒ«ã®è£œå®Œ ---
      - name: ğŸ“¦ Install Remaining Bootstrap Tools
        run: |
          if [ "${{ matrix.pkg_manager }}" = "apt" ]; then
            export DEBIAN_FRONTEND=noninteractive
            apt-get install -y sudo curl locales
            locale-gen en_US.UTF-8
          else
            dnf install -y --allowerasing sudo curl langpacks-en
          fi

      # --- 4. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œ ---
      - name: ğŸ› ï¸ Execute initrc Installer
        env:
          CI: true
          DEBIAN_FRONTEND: noninteractive
        run: |
          chmod +x install.sh
          ./install.sh

      # --- 5. ãƒ„ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ã®æ¤œè¨¼ ---
      - name: ğŸ” Verify Global Command Links (~/bin)
        run: |
          export PATH="$HOME/bin:$HOME/.local/bin:$PATH"
          echo "--- Checking Modern CLI Tools ---"
          eza --version
          (bat --version || batcat --version)
          (fd --version || fdfind --version)
          
          echo "--- Checking AI Wrappers ---"
          [ -f "$HOME/bin/ginv" ] && echo "âœ… ginv created"
          [ -x "$HOME/bin/ginv" ] && echo "âœ… ginv is executable"

      # --- 6. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ ---
      - name: ğŸ›¡ï¸ Verify Shell Configs & Syntax
        run: |
          grep -q 'export PATH="$HOME/bin:$PATH"' "$HOME/.zshrc"
          zsh -n "$HOME/.zshrc"
