name: ğŸ³ Linux Distros Compatibility Test

on:
  push:
    branches: [ main ]
    paths:
      - 'install.sh'
      - 'common/**'
      - 'bin/**'
      - '.github/workflows/linux-distros.yml'
  pull_request:
    branches: [ main ]

jobs:
  matrix-test:
    name: ğŸš€ ${{ matrix.os }} Build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: "Ubuntu 24.04"
            image: "ubuntu:24.04"
            pkg_manager: "apt"
          - os: "AlmaLinux 9"
            image: "almalinux:9"
            pkg_manager: "dnf"

    # ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã§å®šç¾©ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨
    container:
      image: ${{ matrix.image }}
      options: --user root

    steps:
      # --- 1. ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ã“ã“ãŒè§£æ±ºã®éµ) ---
      # actions/checkout ãŒã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã€ã¾ãš Git ã‚’å…¥ã‚Œã‚‹
      - name: ğŸ“¦ Pre-install Git for Submodules
        run: |
          if [ "${{ matrix.pkg_manager }}" = "apt" ]; then
            apt-get update && apt-get install -y git
          else
            dnf install -y git
          fi

      # --- 2. ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ ---
      # ã‚³ãƒ³ãƒ†ãƒŠå†…ã« Git ãŒã‚ã‚‹ã®ã§ã€recursive ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
      - name: ğŸšš Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # --- 3. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ„ãƒ¼ãƒ«ã®è£œå®Œ ---
      - name: ğŸ“¦ Install Remaining Bootstrap Tools
        run: |
          if [ "${{ matrix.pkg_manager }}" = "apt" ]; then
            apt-get install -y sudo curl locales
            locale-gen en_US.UTF-8
          else
            dnf install -y sudo curl langpacks-en
          fi

      # --- 4. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œ ---
      - name: ğŸ› ï¸ Execute initrc Installer
        env:
          CI: true
        run: |
          chmod +x install.sh
          ./install.sh

      # --- 5. ãƒ„ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ã®æ¤œè¨¼ ---
      - name: ğŸ” Verify Global Command Links (~/bin)
        run: |
          # ãƒ‘ã‚¹ã‚’ä¸€æ™‚çš„ã«é€šã—ã¦æ¤œè¨¼
          export PATH="$HOME/bin:$HOME/.local/bin:$PATH"
          
          echo "--- Checking Modern CLI Tools ---"
          eza --version || (echo "âŒ eza missing" && exit 1)
          
          # bat / fd ã® OS åˆ¥ãƒªãƒ³ã‚¯è§£æ±ºãƒã‚§ãƒƒã‚¯
          (bat --version || batcat --version) && echo "âœ… bat is ready"
          (fd --version || fdfind --version) && echo "âœ… fd is ready"
          
          echo "--- Checking AI Wrappers ---"
          [ -f "$HOME/bin/ginv" ] && echo "âœ… ginv created" || (echo "âŒ ginv missing" && exit 1)
          [ -x "$HOME/bin/ginv" ] && echo "âœ… ginv is executable"

      # --- 6. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ ---
      - name: ğŸ›¡ï¸ Verify Shell Configs & Syntax
        run: |
          echo "Checking .zshrc path injection..."
          grep -q 'export PATH="$HOME/bin:$PATH"' "$HOME/.zshrc" && echo "âœ… PATH injected into .zshrc"
          
          echo "Checking zsh syntax..."
          zsh -n "$HOME/.zshrc" && echo "âœ… .zshrc syntax is valid"

      - name: âœ¨ Done
        run: echo "Successfully verified on ${{ matrix.os }}!"
