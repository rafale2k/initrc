# --- AI Commit Message Generator (Stable & Multi-Proposal) ---
_ai_generate_commit_proposals() {
    [[ -z "$GEMINI_API_KEY" ]] && return 1

    local diff_b64
    # diffã‚’Base64åŒ–ã€‚ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã‚„ç‰¹æ®Šæ–‡å­—ã‚’Pythonã¸å®‰å…¨ã«æ¸¡ã™
    diff_b64=$(git diff --cached | head -c 10000 | base64 | tr -d '\n')
    [[ -z "$diff_b64" ]] && return 1

    export DIFF_B64_DATA="$diff_b64"
    export GEMINI_API_KEY_ENV="$GEMINI_API_KEY"

    python3 <<'EOF'
import json
import urllib.request
import os
import base64

def fetch():
    key = os.environ.get("GEMINI_API_KEY_ENV")
    b64_diff = os.environ.get("DIFF_B64_DATA", "")
    if not key or not b64_diff: return

    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={key}"

    sys_inst = (
        "You are an expert developer. The input is a Base64 encoded git diff. "
        "Decode it and provide 3 distinct high-quality commit messages in English. "
        "Format: Conventional Commits (e.g., feat:, fix:, docs:, chore:). "
        "Output ONLY 3 lines of messages. No numbers, no markdown code blocks."
    )

    payload = {
        "system_instruction": {"parts": [{"text": sys_inst}]},
        "contents": [{"parts": [{"text": f"Base64 Diff:\n{b64_diff}"}]}]
    }

    try:
        req = urllib.request.Request(url, data=json.dumps(payload).encode("utf-8"), headers={"Content-Type": "application/json"})
        with urllib.request.urlopen(req, timeout=10) as res:
            data = json.loads(res.read().decode("utf-8"))
            text = data['candidates'][0]['content']['parts'][0]['text']
            # è¡Œã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã€‚ä¸è¦ãªè¨˜å·ã‚„æ•°å­—ã‚’å‰Šé™¤
            lines = [l.strip().lstrip('1234567890.+-* ').strip('` ') for l in text.strip().split('\n') if l.strip()]
            for l in lines[:3]: print(l)
    except Exception as e:
        pass

fetch()
EOF
    unset DIFF_B64_DATA
    unset GEMINI_API_KEY_ENV
}

gcm() {
    # 1. å·®åˆ†ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    local current_diff
    current_diff=$(git diff --cached)
    if [[ -z "$current_diff" ]]; then
        echo "âŒ No changes staged. (Use 'git add' first)"
        return 1
    fi

    echo "ğŸ¤– AI is thinking (Gemini 1.5 Flash Mode)..."

    # 2. ãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ç”Ÿæˆ
    local proposals
    proposals=$(_ai_generate_commit_proposals)

    # 3. é¸æŠè‚¢ã®æ§‹ç¯‰
    local -a choices
    if [[ -n "$proposals" ]]; then
        while IFS= read -r line; do
            choices+=("$line")
        done <<< "$proposals"
    else
        echo "âš ï¸  AI failed to respond. Using defaults."
    fi

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é¸æŠè‚¢ã‚’è¿½åŠ 
    choices+=("feat: update configuration" "fix: minor bug fixes" "[Manual Input]")

    # 4. fzf ã«ã‚ˆã‚‹é¸æŠ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ä»˜ã)
    local selected
    # fzf ã®ä¸­ã§ git diff --cached --color ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ã§ã€å†…å®¹ã‚’ç¢ºèªã—ãªãŒã‚‰é¸ã¹ã‚‹
    selected=$(printf "%s\n" "${choices[@]}" | fzf \
        --height 60% \
        --reverse \
        --border \
        --ansi \
        --header "Select a commit message (ESC to cancel)" \
        --preview "echo '--- Git Diff (Staged) ---\n'; git diff --cached --color=always" \
        --preview-window "right:50%:wrap")

    # 5. ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
    [[ -z "$selected" ]] && { echo "Aborted."; return 0; }

    # 6. æ‰‹å‹•å…¥åŠ›å‡¦ç†
    if [[ "$selected" == "[Manual Input]" ]]; then
        echo -n "âœï¸ Enter your message: "
        read -r manual_message
        selected=$manual_message
    fi

    # 7. ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
    if [[ -z "$selected" ]]; then
        echo "âŒ Message cannot be empty."
        return 1
    fi

    git commit -m "$selected"
}
