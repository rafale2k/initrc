name: ğŸ³ Linux Distros Compatibility Test

on:
  push:
    branches: [ main ]
    paths:
      - 'install.sh'
      - 'common/**'
      - 'bin/**'
      - '.github/workflows/linux-distros.yml'
  pull_request:
    branches: [ main ]

jobs:
  matrix-test:
    name: ğŸš€ ${{ matrix.os }} Build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: "Ubuntu 24.04"
            image: "ubuntu:24.04"
            pkg_manager: "apt"
          - os: "AlmaLinux 9"
            image: "almalinux:9"
            pkg_manager: "dnf"

    container:
      image: ${{ matrix.image }}
      options: --user root

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ“¦ Install Bootstrap Tools (${{ matrix.pkg_manager }})
        run: |
          if [ "${{ matrix.pkg_manager }}" = "apt" ]; then
            apt-get update && apt-get install -y sudo git curl locales
            locale-gen en_US.UTF-8
          else
            dnf install -y sudo git curl langpacks-en
          fi

      - name: ğŸ› ï¸ Execute initrc Installer
        env:
          # CIç’°å¢ƒã§ã®å®Ÿè¡Œã‚’æ˜ç¤º
          CI: true
        run: |
          chmod +x install.sh
          ./install.sh

      - name: ğŸ” Verify Global Command Links (~/bin)
        run: |
          # ãƒ‘ã‚¹ã‚’åæ˜ ã•ã›ã¦ã‚³ãƒãƒ³ãƒ‰ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          export PATH="$HOME/bin:$HOME/.local/bin:$PATH"
          
          echo "--- Checking Modern CLI Tools ---"
          eza --version || (echo "âŒ eza missing" && exit 1)
          
          # bat / fd ã®ãƒªãƒ³ã‚¯è§£æ±ºãƒã‚§ãƒƒã‚¯
          (bat --version || batcat --version) && echo "âœ… bat is ready"
          (fd --version || fdfind --version) && echo "âœ… fd is ready"
          
          echo "--- Checking AI Wrappers ---"
          [ -f "$HOME/bin/ginv" ] && echo "âœ… ginv created" || (echo "âŒ ginv missing" && exit 1)
          [ -x "$HOME/bin/ginv" ] && echo "âœ… ginv is executable"

      - name: ğŸ›¡ï¸ Verify Shell Configs
        run: |
          echo "Checking .zshrc path injection..."
          grep -q 'export PATH="$HOME/bin:$PATH"' "$HOME/.zshrc" && echo "âœ… PATH injected into .zshrc"

      - name: ğŸš Zsh Syntax Check
        run: |
          zsh -n "$HOME/.zshrc" && echo "âœ… .zshrc syntax is valid"
